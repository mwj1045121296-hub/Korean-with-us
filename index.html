<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¸­è‹±éŸ©å¥å­æ‹¼å›¾å­¦ä¹ æ¸¸æˆ</title>
  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,
                   "Noto Sans CJK SC","Malgun Gothic",sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #1e293b 0, #020617 45%),
        radial-gradient(circle at 100% 100%, #0f172a 0, #020617 55%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      position:relative;
      padding:18px 26px 22px;
      background:radial-gradient(circle at 0% 0%, #4f46e5 0, #111827 50%);
      border-bottom:1px solid rgba(148,163,184,0.4);
      overflow:hidden;
    }
    header::before{
      content:"";
      position:absolute;
      inset:-120px;
      background:
        radial-gradient(circle at 10% 20%, rgba(129,140,248,.55) 0, transparent 45%),
        radial-gradient(circle at 90% 80%, rgba(34,197,94,.4) 0, transparent 50%);
      opacity:.8;
      pointer-events:none;
    }
    header::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(120deg, rgba(15,23,42,.4), transparent),
        linear-gradient(300deg, rgba(15,23,42,.7), transparent);
      pointer-events:none;
    }
    header>*{position:relative;z-index:1;}
    h1{
      margin:0 0 4px;
      font-size:24px;
      letter-spacing:.03em;
    }
    header p{
      margin:0;
      font-size:13px;
      opacity:.9;
    }
    .lang-switch{
      position:absolute;
      top:10px;
      right:20px;
      display:flex;
      gap:6px;
      z-index:2;
    }
    .lang-switch button{
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.7);
      color:#e5e7eb;
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:4px;
      transition:all .2s ease-out;
      backdrop-filter:blur(10px);
    }
    .lang-switch button:hover{
      transform:translateY(-1px);
      background:rgba(30,64,175,.9);
      border-color:rgba(191,219,254,.9);
      box-shadow:0 8px 18px rgba(37,99,235,.45);
    }
    main{
      flex:1;
      max-width:960px;
      width:100%;
      margin:18px auto 24px;
      padding:0 16px;
    }
    .card{
      background:radial-gradient(circle at 0 0, rgba(148,163,184,.22), transparent 55%),
                 rgba(15,23,42,.9);
      border-radius:14px;
      padding:16px 18px 18px;
      border:1px solid rgba(148,163,184,.45);
      box-shadow:0 18px 40px rgba(15,23,42,.95);
      backdrop-filter:blur(14px);
      transition:transform .18s ease-out, box-shadow .18s ease-out,
                 border-color .18s ease-out, background .18s ease-out;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 24px 55px rgba(15,23,42,.98),
                 0 0 0 1px rgba(56,189,248,.35);
      border-color:rgba(96,165,250,.7);
      background:radial-gradient(circle at 0 0, rgba(129,140,248,.32), transparent 55%),
                 rgba(15,23,42,.95);
    }
    h2{
      margin:0 0 8px;
      font-size:18px;
      letter-spacing:.02em;
    }
    .mode-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
      font-size:13px;
      color:#cbd5f5;
    }
    .mode-buttons{
      display:flex;
      gap:6px;
    }
    .pill-btn{
      border-radius:999px;
      padding:4px 10px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      font-size:12px;
      cursor:pointer;
      transition:all .18s ease-out;
    }
    .pill-btn.active{
      background:linear-gradient(135deg,#4f46e5,#22c55e);
      border-color:rgba(191,219,254,.9);
      box-shadow:0 6px 18px rgba(30,64,175,.8);
    }
    .pill-btn:hover{
      transform:translateY(-1px);
    }
    .prompt{
      margin:6px 0 10px;
      font-size:14px;
      color:#e5e7eb;
    }
    .prompt span{
      color:#a5b4fc;
      font-weight:600;
    }
    .zh-sentence{
      font-size:18px;
      margin-bottom:10px;
    }
    .tokens-row,.answer-row{
      min-height:44px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      padding:8px;
      border-radius:10px;
      border:1px dashed rgba(148,163,184,.5);
      background:rgba(15,23,42,.8);
      margin-bottom:8px;
    }
    .tokens-row{
      margin-top:4px;
    }
    .token{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.95);
      border:1px solid rgba(148,163,184,.7);
      font-size:13px;
      cursor:pointer;
      transition:all .15s ease-out;
      user-select:none;
    }
    .token.used{
      opacity:.3;
      cursor:default;
      transform:none;
    }
    .token:hover:not(.used){
      transform:translateY(-1px);
      box-shadow:0 6px 12px rgba(15,23,42,.85);
      background:rgba(30,64,175,.9);
    }
    .answer-row.empty::before{
      content:attr(data-placeholder);
      font-size:12px;
      color:#6b7280;
    }
    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .primary-btn,.secondary-btn{
      border-radius:999px;
      padding:6px 14px;
      font-size:13px;
      border:none;
      cursor:pointer;
      transition:all .18s ease-out;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .primary-btn{
      background:linear-gradient(135deg,#4f46e5,#22c55e);
      color:#f9fafb;
      box-shadow:0 8px 20px rgba(30,64,175,.9);
    }
    .primary-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 30px rgba(30,64,175,1);
    }
    .secondary-btn{
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.7);
    }
    .secondary-btn:hover{
      background:rgba(30,64,175,.9);
      border-color:rgba(191,219,254,.9);
    }
    .feedback{
      margin-top:8px;
      font-size:13px;
      min-height:18px;
    }
    .feedback.ok{color:#4ade80;}
    .feedback.err{color:#fb7185;}
    .stats-line{
      margin-top:8px;
      font-size:12px;
      color:#9ca3af;
    }
    footer{
      max-width:960px;
      margin:0 auto 14px;
      padding:0 16px;
      font-size:11px;
      color:#9ca3af;
      text-align:right;
    }
    @media (max-width:640px){
      header{padding:16px 14px 20px;}
      h1{font-size:20px;}
      .lang-switch{position:static;justify-content:flex-end;margin-bottom:6px;}
    }
  </style>
</head>
<body>
<header>
  <div class="lang-switch">
    <button onclick="setUILang('zh')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
    <button onclick="setUILang('en')">ğŸ‡¬ğŸ‡§ English</button>
    <button onclick="setUILang('kr')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
  </div>
  <h1 id="title">ä¸­è‹±éŸ©å¥å­æ‹¼å›¾å­¦ä¹ æ¸¸æˆ</h1>
  <p id="subtitle">é€šè¿‡æ‹–æ‹½å•è¯ï¼Œç»ƒä¹ ä¸­æ–‡ â†’ è‹±æ–‡ / éŸ©æ–‡çš„è¯­åºå’Œè¡¨è¾¾ã€‚</p>
</header>

<main>
  <section class="card">
    <div class="mode-row">
      <span id="modeLabel">ç»ƒä¹ è¯­è¨€ï¼š</span>
      <div class="mode-buttons">
        <button class="pill-btn active" id="btnModeEn" onclick="setPracticeMode('en')">English</button>
        <button class="pill-btn" id="btnModeKr" onclick="setPracticeMode('kr')">í•œêµ­ì–´</button>
      </div>
    </div>

    <div class="prompt">
      <div id="promptText">è¯·æ ¹æ®ä¸‹é¢çš„ä¸­æ–‡å¥å­ï¼Œç”¨ç›®æ ‡è¯­è¨€æ‹¼å‡ºæ­£ç¡®çš„å¥å­ï¼š</div>
      <div class="zh-sentence" id="zhSentence">â€¦â€¦</div>
    </div>

    <div>
      <div style="font-size:12px;color:#9ca3af;margin-bottom:2px;" id="tokensLabel">
        ç‚¹å‡»ä¸‹é¢çš„è¯è¯­ï¼ŒæŠŠå®ƒä»¬æŒ‰æ­£ç¡®é¡ºåºæ”¾åˆ°â€œä½ çš„ç­”æ¡ˆâ€ä¸­ï¼š
      </div>
      <div class="tokens-row" id="tokensRow"></div>
    </div>

    <div style="margin-top:6px;">
      <div style="font-size:12px;color:#9ca3af;margin-bottom:2px;" id="answerLabel">
        ä½ çš„ç­”æ¡ˆï¼š
      </div>
      <div class="answer-row empty" id="answerRow" data-placeholder="ç‚¹å‡»ä¸Šé¢çš„è¯è¯­å¼€å§‹æ‹¼å¥å­"></div>
    </div>

    <div class="btn-row">
      <button class="primary-btn" id="btnCheck" onclick="checkAnswer()">âœ… <span>æ£€æŸ¥ç­”æ¡ˆ</span></button>
      <button class="secondary-btn" id="btnReset" onclick="resetCurrent()">ğŸ” <span>é‡æ¥</span></button>
      <button class="secondary-btn" id="btnNext" onclick="nextSentence()">â­ <span>ä¸‹ä¸€å¥</span></button>
    </div>

    <div class="feedback" id="feedback"></div>
    <div class="stats-line" id="statsLine">å·²åš 0 é¢˜ï¼Œå…¶ä¸­ 0 é¢˜æ­£ç¡®ï¼Œæ­£ç¡®ç‡ 0%ã€‚</div>
  </section>
</main>

<footer id="footerNote">
  æç¤ºï¼šé¢˜åº“å¯æ ¹æ®éœ€è¦ç»§ç»­æ‰©å……ï¼Œæ”¯æŒä¸­æ–‡ â†’ è‹±æ–‡ / éŸ©æ–‡åŒå‘ç»ƒä¹ ã€‚
</footer>

<script>
  // é¢˜åº“ï¼šä¸­æ–‡ + è‹±æ–‡ + éŸ©æ–‡ï¼ˆåˆ†è¯ç‰ˆç”¨äºæ‹¼å¥å­ï¼‰
  const SENTENCES = [
    {
      zh: "æˆ‘éœ€è¦å¸®åŠ©",
      enSegments: ["I", "need", "help."],
      enFull: "I need help.",
      krSegments: ["ì €ëŠ”", "ë„ì›€ì´", "í•„ìš”í•´ìš”."],
      krFull: "ì €ëŠ” ë„ì›€ì´ í•„ìš”í•´ìš”."
    },
    {
      zh: "æˆ‘çš„éŸ©è¯­ä¸å¤ªå¥½",
      enSegments: ["My", "Korean", "is", "not", "very", "good."],
      enFull: "My Korean is not very good.",
      krSegments: ["ì œ", "í•œêµ­ì–´ëŠ”", "ì•„ì§", "ë§ì´", "ë¶€ì¡±í•´ìš”."],
      krFull: "ì œ í•œêµ­ì–´ëŠ” ì•„ì§ ë§ì´ ë¶€ì¡±í•´ìš”."
    },
    {
      zh: "ä¸å¥½æ„æ€ï¼Œç»™ä½ æ·»éº»çƒ¦äº†",
      enSegments: ["I'm", "sorry", "to", "bother", "you."],
      enFull: "I'm sorry to bother you.",
      krSegments: ["ë²ˆê±°ë¡­ê²Œ", "í•´", "ë“œë ¤ì„œ", "ì£„ì†¡í•´ìš”."],
      krFull: "ë²ˆê±°ë¡­ê²Œ í•´ ë“œë ¤ì„œ ì£„ì†¡í•´ìš”."
    },
    {
      zh: "æˆ‘éœ€è¦ä¸€å¼ ç¥¨",
      enSegments: ["I", "need", "a", "ticket."],
      enFull: "I need a ticket.",
      krSegments: ["í‘œ", "í•œ", "ì¥ì´", "í•„ìš”í•´ìš”."],
      krFull: "í‘œ í•œ ì¥ì´ í•„ìš”í•´ìš”."
    },
    {
      zh: "ä½ ä»€ä¹ˆæ—¶å€™æœ‰æ—¶é—´",
      enSegments: ["When", "do", "you", "have", "time?"],
      enFull: "When do you have time?",
      krSegments: ["ì–¸ì œ", "ì‹œê°„ì´", "ìˆì–´ìš”?"],
      krFull: "ì–¸ì œ ì‹œê°„ì´ ìˆì–´ìš”?"
    },
    {
      zh: "ä»Šå¤©çœŸçš„å¾ˆæ„‰å¿«",
      enSegments: ["Today", "was", "really", "fun."],
      enFull: "Today was really fun.",
      krSegments: ["ì˜¤ëŠ˜", "ì •ë§", "ì¦ê±°ì› ì–´ìš”."],
      krFull: "ì˜¤ëŠ˜ ì •ë§ ì¦ê±°ì› ì–´ìš”."
    },
    {
      zh: "è°¢è°¢ä½ çš„å¸®åŠ©",
      enSegments: ["Thank", "you", "for", "your", "help."],
      enFull: "Thank you for your help.",
      krSegments: ["ë„ì™€ì£¼ì…”ì„œ", "ê°ì‚¬í•©ë‹ˆë‹¤."],
      krFull: "ë„ì™€ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤."
    },
    {
      zh: "æˆ‘ä»¬ä¸€èµ·åƒé¥­å§",
      enSegments: ["Let's", "eat", "together."],
      enFull: "Let's eat together.",
      krSegments: ["ìš°ë¦¬", "ê°™ì´", "ë°¥", "ë¨¹ì–´ìš”."],
      krFull: "ìš°ë¦¬ ê°™ì´ ë°¥ ë¨¹ì–´ìš”."
    },
    {
      zh: "ä½ çš„çˆ±å¥½æ˜¯ä»€ä¹ˆ",
      enSegments: ["What", "is", "your", "hobby?"],
      enFull: "What is your hobby?",
      krSegments: ["ì·¨ë¯¸ê°€", "ë­ì˜ˆìš”?"],
      krFull: "ì·¨ë¯¸ê°€ ë­ì˜ˆìš”?"
    },
    {
      zh: "ä½ çš„æ•…ä¹¡æ˜¯å“ªé‡Œ",
      enSegments: ["Where", "is", "your", "hometown?"],
      enFull: "Where is your hometown?",
      krSegments: ["ê³ í–¥ì´", "ì–´ë””ì˜ˆìš”?"],
      krFull: "ê³ í–¥ì´ ì–´ë””ì˜ˆìš”?"
    },
    {
      zh: "ä½ å–å’–å•¡å—",
      enSegments: ["Do", "you", "drink", "coffee?"],
      enFull: "Do you drink coffee?",
      krSegments: ["ì»¤í”¼ë¥¼", "ë§ˆì…”ìš”?"],
      krFull: "ì»¤í”¼ë¥¼ ë§ˆì…”ìš”?"
    },
    {
      zh: "é‚£ä¸ªäººæ˜¯è°",
      enSegments: ["Who", "is", "that", "person?"],
      enFull: "Who is that person?",
      krSegments: ["ì €", "ì‚¬ëŒì€", "ëˆ„êµ¬ì˜ˆìš”?"],
      krFull: "ì € ì‚¬ëŒì€ ëˆ„êµ¬ì˜ˆìš”?"
    },
    {
      zh: "æˆ‘éœ€è¦æ‰“åŒ…",
      enSegments: ["I'd", "like", "to", "take", "this", "to", "go."],
      enFull: "I'd like to take this to go.",
      krSegments: ["ì´ê±°", "í¬ì¥í•´", "ì£¼ì„¸ìš”."],
      krFull: "ì´ê±° í¬ì¥í•´ ì£¼ì„¸ìš”."
    }
  ];

  // ç•Œé¢è¯­è¨€æ–‡æœ¬
  const UI_TEXT = {
    zh: {
      title: "ä¸­è‹±éŸ©å¥å­æ‹¼å›¾å­¦ä¹ æ¸¸æˆ",
      subtitle: "é€šè¿‡æ‹–æ‹½å•è¯ï¼Œç»ƒä¹ ä¸­æ–‡ â†’ è‹±æ–‡ / éŸ©æ–‡çš„è¯­åºå’Œè¡¨è¾¾ã€‚",
      modeLabel: "ç»ƒä¹ è¯­è¨€ï¼š",
      promptText: "è¯·æ ¹æ®ä¸‹é¢çš„ä¸­æ–‡å¥å­ï¼Œç”¨ç›®æ ‡è¯­è¨€æ‹¼å‡ºæ­£ç¡®çš„å¥å­ï¼š",
      tokensLabel: "ç‚¹å‡»ä¸‹é¢çš„è¯è¯­ï¼ŒæŠŠå®ƒä»¬æŒ‰æ­£ç¡®é¡ºåºæ”¾åˆ°â€œä½ çš„ç­”æ¡ˆâ€ä¸­ï¼š",
      answerLabel: "ä½ çš„ç­”æ¡ˆï¼š",
      btnCheck: "æ£€æŸ¥ç­”æ¡ˆ",
      btnReset: "é‡æ¥",
      btnNext: "ä¸‹ä¸€å¥",
      stats: (t, c) => {
        const acc = t === 0 ? 0 : Math.round((c / t) * 100);
        return `å·²åš ${t} é¢˜ï¼Œå…¶ä¸­ ${c} é¢˜æ­£ç¡®ï¼Œæ­£ç¡®ç‡ ${acc}%ã€‚`;
      },
      correct: "âœ… æ­£ç¡®ï¼åšå¾—å¾ˆå¥½ï¼",
      wrong: (correct) => `âŒ è¿˜ä¸å¤ªå¯¹ï¼Œå¯ä»¥å†è¯•ä¸€æ¬¡ã€‚\næ­£ç¡®ç­”æ¡ˆï¼š${correct}`,
      footer: "æç¤ºï¼šé¢˜åº“å¯æ ¹æ®éœ€è¦ç»§ç»­æ‰©å……ï¼Œæ”¯æŒä¸­æ–‡ â†’ è‹±æ–‡ / éŸ©æ–‡åŒå‘ç»ƒä¹ ã€‚"
    },
    en: {
      title: "CNâ€“ENâ€“KR Sentence Puzzle Learning Game",
      subtitle: "Drag and arrange words to build correct English / Korean sentences from Chinese prompts.",
      modeLabel: "Practice language:",
      promptText: "Read the Chinese sentence and build the correct sentence in the target language:",
      tokensLabel: "Click the words below to move them into your answer in the correct order:",
      answerLabel: "Your answer:",
      btnCheck: "Check",
      btnReset: "Reset",
      btnNext: "Next",
      stats: (t, c) => {
        const acc = t === 0 ? 0 : Math.round((c / t) * 100);
        return `Questions: ${t}, Correct: ${c}, Accuracy: ${acc}%.`;
      },
      correct: "âœ… Correct! Great job!",
      wrong: (correct) => `âŒ Not quite. Try again.\nCorrect answer: ${correct}`,
      footer: "Note: You can expand the sentence bank and use this tool to practice CNâ†’EN / CNâ†’KR."
    },
    kr: {
      title: "ì¤‘Â·ì˜Â·í•œ ë¬¸ì¥ í¼ì¦ í•™ìŠµ ê²Œì„",
      subtitle: "ì¤‘êµ­ì–´ ë¬¸ì¥ì„ ë³´ê³  ì˜ì–´/í•œêµ­ì–´ ë‹¨ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ë°°ì—´í•´ ë³´ì„¸ìš”.",
      modeLabel: "ì—°ìŠµ ì–¸ì–´:",
      promptText: "ì•„ë˜ ì¤‘êµ­ì–´ ë¬¸ì¥ì„ ë³´ê³ , ëª©í‘œ ì–¸ì–´ë¡œ ì˜¬ë°”ë¥¸ ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”:",
      tokensLabel: "ì•„ë˜ ë‹¨ì–´ë¥¼ í´ë¦­í•´ì„œ â€˜ë‚˜ì˜ ë‹µâ€™ ì˜ì—­ì— ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë„£ì–´ ë³´ì„¸ìš”:",
      answerLabel: "ë‚˜ì˜ ë‹µ:",
      btnCheck: "ì •ë‹µ í™•ì¸",
      btnReset: "ë‹¤ì‹œ í•˜ê¸°",
      btnNext: "ë‹¤ìŒ ë¬¸ì¥",
      stats: (t, c) => {
        const acc = t === 0 ? 0 : Math.round((c / t) * 100);
        return `ì´ ${t}ë¬¸í•­ ì¤‘ ${c}ë¬¸í•­ ì •ë‹µ, ì •ë‹µë¥  ${acc}%.`;
      },
      correct: "âœ… ì •ë‹µì…ë‹ˆë‹¤! ì˜í•˜ì…¨ì–´ìš”!",
      wrong: (correct) => `âŒ ì•„ì§ ì •ë‹µì´ ì•„ë‹ˆì—ìš”. í•œ ë²ˆ ë” ë„ì „í•´ ë³´ì„¸ìš”.\nì •ë‹µ: ${correct}`,
      footer: "ì•ˆë‚´: ë¬¸ì¥ ë°ì´í„°ëŠ” ììœ ë¡­ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìœ¼ë©°, ì¤‘â†’ì˜ / ì¤‘â†’í•œ ì—°ìŠµì— í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    }
  };

  let uiLang = "zh";       // ç•Œé¢è¯­è¨€
  let practiceLang = "en"; // ç»ƒä¹ è‹±è¯­ or éŸ©è¯­
  let currentIndex = 0;
  let usedIndices = [];
  let currentAnswer = [];
  let currentTokens = [];
  let currentCorrectString = "";
  let totalTried = 0;
  let totalCorrect = 0;

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function setUILang(lang) {
    uiLang = lang;
    const t = UI_TEXT[lang];
    document.getElementById("title").innerText = t.title;
    document.getElementById("subtitle").innerText = t.subtitle;
    document.getElementById("modeLabel").innerText = t.modeLabel;
    document.getElementById("promptText").innerText = t.promptText;
    document.getElementById("tokensLabel").innerText = t.tokensLabel;
    document.getElementById("answerLabel").innerText = t.answerLabel;
    document.getElementById("btnCheck").innerHTML = "âœ… <span>" + t.btnCheck + "</span>";
    document.getElementById("btnReset").innerHTML = "ğŸ” <span>" + t.btnReset + "</span>";
    document.getElementById("btnNext").innerHTML = "â­ <span>" + t.btnNext + "</span>";
    document.getElementById("footerNote").innerText = t.footer;
    updateStatsLine();
  }

  function setPracticeMode(lang) {
    practiceLang = lang;
    document.getElementById("btnModeEn").classList.toggle("active", lang === "en");
    document.getElementById("btnModeKr").classList.toggle("active", lang === "kr");
    nextSentence(true);
  }

  function pickNextIndex() {
    if (usedIndices.length === SENTENCES.length) {
      usedIndices = [];
    }
    let idx;
    do {
      idx = Math.floor(Math.random() * SENTENCES.length);
    } while (usedIndices.includes(idx));
    usedIndices.push(idx);
    return idx;
  }

  function renderSentence() {
    const s = SENTENCES[currentIndex];
    document.getElementById("zhSentence").innerText = s.zh;
    const segments = practiceLang === "en" ? s.enSegments : s.krSegments;
    currentCorrectString = (practiceLang === "en" ? s.enFull : s.krFull);
    currentTokens = shuffle(segments);
    currentAnswer = [];

    const tokensRow = document.getElementById("tokensRow");
    const answerRow = document.getElementById("answerRow");
    tokensRow.innerHTML = "";
    answerRow.innerHTML = "";
    answerRow.classList.add("empty");
    answerRow.setAttribute("data-placeholder",
      uiLang === "zh" ? "ç‚¹å‡»ä¸Šé¢çš„è¯è¯­å¼€å§‹æ‹¼å¥å­" :
      uiLang === "en" ? "Click words above to start building the sentence" :
      "ìœ„ ë‹¨ì–´ë¥¼ í´ë¦­í•´ì„œ ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”"
    );

    currentTokens.forEach((tok, i) => {
      const btn = document.createElement("div");
      btn.className = "token";
      btn.innerText = tok;
      btn.dataset.index = i;
      btn.addEventListener("click", () => {
        if (btn.classList.contains("used")) return;
        btn.classList.add("used");
        currentAnswer.push(tok);
        renderAnswerRow();
      });
      tokensRow.appendChild(btn);
    });

    document.getElementById("feedback").innerText = "";
    document.getElementById("feedback").className = "feedback";
  }

  function renderAnswerRow() {
    const answerRow = document.getElementById("answerRow");
    answerRow.innerHTML = "";
    if (currentAnswer.length === 0) {
      answerRow.classList.add("empty");
      return;
    }
    answerRow.classList.remove("empty");
    currentAnswer.forEach(tok => {
      const chip = document.createElement("div");
      chip.className = "token";
      chip.innerText = tok;
      chip.style.cursor = "default";
      chip.style.opacity = 0.9;
      answerRow.appendChild(chip);
    });
  }

  function resetCurrent() {
    currentAnswer = [];
    renderSentence();
  }

  function checkAnswer() {
    if (currentAnswer.length === 0) return;
    totalTried++;
    const userStr = currentAnswer.join(" ");
    const t = UI_TEXT[uiLang];
    const fb = document.getElementById("feedback");
    if (userStr === currentCorrectString) {
      totalCorrect++;
      fb.className = "feedback ok";
      fb.innerText = t.correct;
    } else {
      fb.className = "feedback err";
      fb.innerText = t.wrong(currentCorrectString);
    }
    updateStatsLine();
  }

  function updateStatsLine() {
    const t = UI_TEXT[uiLang];
    document.getElementById("statsLine").innerText = t.stats(totalTried, totalCorrect);
  }

  function nextSentence(fromModeChange=false) {
    currentIndex = pickNextIndex();
    renderSentence();
    if (!fromModeChange) {
      const fb = document.getElementById("feedback");
      fb.innerText = "";
      fb.className = "feedback";
    }
  }

  // åˆå§‹åŒ–
  setUILang("zh");
  setPracticeMode("en");
  currentIndex = pickNextIndex();
  renderSentence();
</script>
</body>
</html>
